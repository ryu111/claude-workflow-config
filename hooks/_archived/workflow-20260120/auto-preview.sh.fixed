#!/usr/bin/env bash
# auto-preview.sh
# PostToolUse (Task) Hook - è‡ªå‹•é–‹å•Ÿ TESTER æˆæœé è¦½
#
# åŠŸèƒ½ï¼š
# - ç•¶ TESTER è¿”å› PASS æ™‚ï¼Œè‡ªå‹•é–‹å•Ÿ output URL/æª”æ¡ˆ
# - æ”¯æ´è·¨å¹³å°ï¼ˆmacOSã€Linuxã€Windowsï¼‰
# - æ ¹æ“šæª”æ¡ˆé¡å‹é¸æ“‡é©ç•¶çš„æ‡‰ç”¨ç¨‹å¼
#
# è¼¸å…¥ï¼šå¾ stdin æ¥æ”¶ JSON æ ¼å¼çš„ hook input
# {
#   "tool_name": "Task",
#   "tool_input": { "subagent_type": "tester" },
#   "tool_output": "... pass ... output: http://localhost:3000/dashboard ..."
# }

set -euo pipefail

# ============================================================================
# å¸¸æ•¸å®šç¾©
# ============================================================================
readonly CONFIG_FILE="${HOME}/.claude/workflow-config.json"
readonly DEFAULT_AUTO_OPEN="true"
readonly DEFAULT_DELAY_MS=1000

readonly TOOL_NAME_TASK="Task"
readonly SUBAGENT_TYPE_TESTER="tester"
readonly PASS_KEYWORD="pass"

readonly DEBUG="${DEBUG:-false}"

# ============================================================================
# è¼”åŠ©å‡½æ•¸
# ============================================================================
debug_log() {
  [[ "$DEBUG" == "true" ]] && echo "[DEBUG] $*" >&2
}

# é©—è­‰è·¯å¾‘å®‰å…¨æ€§
validate_path() {
  local path="$1"

  # æ‹’çµ•åŒ…å« ../ çš„è·¯å¾‘ï¼ˆé˜²æ­¢ç›®éŒ„éæ­·æ”»æ“Šï¼‰
  if [[ "$path" =~ \.\. ]]; then
    echo "âš ï¸  æ‹’çµ•ä¸å®‰å…¨çš„è·¯å¾‘: $path" >&2
    return 1
  fi

  # æ‹’çµ•åŒ…å«ç‰¹æ®Šå­—å…ƒçš„è·¯å¾‘ï¼ˆé¡å¤–å®‰å…¨æª¢æŸ¥ï¼‰
  if [[ "$path" =~ [;\|\&\$\`] ]]; then
    echo "âš ï¸  è·¯å¾‘åŒ…å«ä¸å®‰å…¨çš„å­—å…ƒ: $path" >&2
    return 1
  fi

  return 0
}

# è·¨å¹³å°é–‹å•Ÿæª”æ¡ˆ
open_file() {
  local file="$1"

  case "$(uname)" in
    Darwin)
      open "$file"
      ;;
    Linux)
      xdg-open "$file" 2>/dev/null
      ;;
    MINGW*|CYGWIN*|MSYS*)
      # Windows çš„ start å‘½ä»¤éœ€è¦ç©ºæ¨™é¡Œåƒæ•¸
      cmd.exe /c start "" "$file" 2>/dev/null
      ;;
    *)
      # æœªçŸ¥å¹³å°ï¼Œå˜—è©¦å¸¸è¦‹å‘½ä»¤
      if command -v xdg-open &>/dev/null; then
        xdg-open "$file"
      elif command -v open &>/dev/null; then
        open "$file"
      else
        echo "âš ï¸  ç„¡æ³•è‡ªå‹•é–‹å•Ÿé è¦½ï¼šæœªæ‰¾åˆ°é©ç•¶çš„é–‹å•Ÿå‘½ä»¤" >&2
        return 1
      fi
      ;;
  esac
}

# é–‹å•Ÿæª”æ¡ˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
open_if_exists() {
  local file="$1"
  local emoji="$2"
  local type="$3"

  if [[ -f "$file" ]]; then
    echo "## $emoji é–‹å•Ÿé è¦½: $file"
    open_file "$file" || echo "âš ï¸  ç„¡æ³•é–‹å•Ÿ $type æª”æ¡ˆ: $file" >&2
  else
    echo "âš ï¸  æª”æ¡ˆä¸å­˜åœ¨: $file" >&2
  fi
}

# ============================================================================
# è®€å–é…ç½®
# ============================================================================
if [[ -f "$CONFIG_FILE" ]]; then
  AUTO_OPEN=$(jq -r '.preview.autoOpenOnTaskComplete // "'"$DEFAULT_AUTO_OPEN"'"' "$CONFIG_FILE" 2>/dev/null || echo "$DEFAULT_AUTO_OPEN")
  DELAY_MS=$(jq -r '.preview.delayMs // '"$DEFAULT_DELAY_MS" "$CONFIG_FILE" 2>/dev/null || echo "$DEFAULT_DELAY_MS")
else
  debug_log "é…ç½®æª”æ¡ˆä¸å­˜åœ¨ï¼Œä½¿ç”¨é è¨­å€¼"
  AUTO_OPEN="$DEFAULT_AUTO_OPEN"
  DELAY_MS="$DEFAULT_DELAY_MS"
fi

debug_log "AUTO_OPEN=$AUTO_OPEN, DELAY_MS=$DELAY_MS"

# å¦‚æœæœªå•Ÿç”¨è‡ªå‹•é è¦½ï¼Œç›´æ¥é€€å‡º
if [[ "$AUTO_OPEN" != "true" ]]; then
  debug_log "è‡ªå‹•é è¦½å·²åœç”¨"
  exit 0
fi

# ============================================================================
# è§£æ Hook Input
# ============================================================================
HOOK_INPUT=$(cat)
debug_log "Received hook input"

# æª¢æŸ¥æ˜¯å¦ç‚º Task å·¥å…·
TOOL_NAME=$(echo "$HOOK_INPUT" | jq -r '.tool_name // ""')
if [[ "$TOOL_NAME" != "$TOOL_NAME_TASK" ]]; then
  debug_log "ä¸æ˜¯ Task å·¥å…·: $TOOL_NAME"
  exit 0
fi

# æª¢æŸ¥æ˜¯å¦ç‚º tester agent
SUBAGENT_TYPE=$(echo "$HOOK_INPUT" | jq -r '.tool_input.subagent_type // ""')
if [[ "$SUBAGENT_TYPE" != "$SUBAGENT_TYPE_TESTER" ]]; then
  debug_log "ä¸æ˜¯ tester agent: $SUBAGENT_TYPE"
  exit 0
fi

# ç²å– tool output
TOOL_OUTPUT=$(echo "$HOOK_INPUT" | jq -r '.tool_output // ""')

# æª¢æŸ¥æ˜¯å¦åŒ…å« "pass" (ä¸å€åˆ†å¤§å°å¯«)
if ! echo "$TOOL_OUTPUT" | grep -qi "$PASS_KEYWORD"; then
  debug_log "æ¸¬è©¦æœªé€šé"
  exit 0
fi

# ============================================================================
# æå–è¼¸å‡ºè·¯å¾‘
# ============================================================================
# æ”¯æ´çš„æ¨¡å¼ï¼š
# - "output: <path>"
# - "Output: <path>"
# - "preview: <path>"
# - "url: <path>"
OUTPUT=$(echo "$TOOL_OUTPUT" | grep -oiE "(output|preview|url):\s+([^\s,;]+)" | head -n1 | sed -E 's/(output|preview|url):\s+//i' | xargs)

# å¦‚æœæ²’æœ‰æ‰¾åˆ° outputï¼Œå˜—è©¦æå– http/https URL
if [[ -z "$OUTPUT" ]]; then
  OUTPUT=$(echo "$TOOL_OUTPUT" | grep -oE 'https?://[^\s]+' | head -n1)
fi

# å¦‚æœä»ç„¶æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦æå–æª”æ¡ˆè·¯å¾‘ï¼ˆ.html, .md, .pdfï¼‰
if [[ -z "$OUTPUT" ]]; then
  OUTPUT=$(echo "$TOOL_OUTPUT" | grep -oE '/[^\s]+\.(html|md|pdf)' | head -n1)
fi

# å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½• outputï¼Œéœé»˜é€€å‡º
if [[ -z "$OUTPUT" ]]; then
  debug_log "æœªæ‰¾åˆ°è¼¸å‡ºè·¯å¾‘"
  exit 0
fi

debug_log "Found output: $OUTPUT"

# é©—è­‰è·¯å¾‘å®‰å…¨æ€§
if ! validate_path "$OUTPUT"; then
  exit 1
fi

# ============================================================================
# å»¶é²ä¸¦é–‹å•Ÿ
# ============================================================================
# å»¶é²ï¼ˆä½¿ç”¨ awk é€²è¡Œæµ®é»æ•¸è¨ˆç®—ï¼Œæ¯” bc æ›´é€šç”¨ï¼‰
DELAY_SEC=$(awk "BEGIN {printf \"%.3f\", $DELAY_MS / 1000}" 2>/dev/null || echo "1")
sleep "$DELAY_SEC"

# åˆ¤æ–· output é¡å‹ä¸¦é–‹å•Ÿ
if [[ "$OUTPUT" =~ ^https?:// ]]; then
  # HTTP/HTTPS URL
  echo "## ğŸ–¥ï¸ é–‹å•Ÿé è¦½: $OUTPUT"
  open_file "$OUTPUT" || echo "âš ï¸  ç„¡æ³•é–‹å•Ÿ URL: $OUTPUT" >&2
elif [[ "$OUTPUT" =~ \.html$ ]]; then
  # HTML æª”æ¡ˆ
  open_if_exists "$OUTPUT" "ğŸ–¥ï¸" "HTML"
elif [[ "$OUTPUT" =~ \.md$ ]]; then
  # Markdown æª”æ¡ˆ
  open_if_exists "$OUTPUT" "ğŸ“„" "Markdown"
elif [[ "$OUTPUT" =~ \.pdf$ ]]; then
  # PDF æª”æ¡ˆ
  open_if_exists "$OUTPUT" "ğŸ“•" "PDF"
else
  # å…¶ä»–é¡å‹ï¼Œå˜—è©¦ç•¶ä½œæª”æ¡ˆæˆ–ç›®éŒ„é–‹å•Ÿ
  if [[ -e "$OUTPUT" ]]; then
    echo "## ğŸ“‚ é–‹å•Ÿ: $OUTPUT"
    open_file "$OUTPUT" || echo "âš ï¸  ç„¡æ³•é–‹å•Ÿ: $OUTPUT" >&2
  else
    echo "âš ï¸  ä¸æ”¯æ´çš„è¼¸å‡ºé¡å‹æˆ–æª”æ¡ˆä¸å­˜åœ¨: $OUTPUT" >&2
  fi
fi

exit 0
