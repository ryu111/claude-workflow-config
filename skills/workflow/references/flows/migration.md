# M→S→W→D→R→T Flow: Migration Workflow

工具/框架遷移的完整流程定義，確保遷移過程安全、有序且可回溯。

## 流程概覽

```
┌──────────────────────────────────────────────────────────────────────┐
│                     M→S→W→D→R→T Flow                                  │
│                                                                      │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                │
│  │  Migration  │   │   Skills    │   │  Workflow   │                │
│  │   Agent     │──→│   Agent     │──→│   Agent     │                │
│  │ (規劃遷移) │   │(建立 skill)│   │ (設計流程) │                │
│  └─────────────┘   └─────────────┘   └─────────────┘                │
│        M                 S                  W                        │
│                                             │                        │
│                                             ▼                        │
│                           ┌─────────────────────────────────┐       │
│                           │         D → R → T               │       │
│                           │   (實作 → 審查 → 測試)          │       │
│                           └─────────────────────────────────┘       │
│                                             │                        │
│                                             ▼                        │
│                                      ┌────────────┐                 │
│                                      │  完成 ✅   │                 │
│                                      └────────────┘                 │
└──────────────────────────────────────────────────────────────────────┘
```

## 觸發條件

| 觸發方式 | 範例 |
|----------|------|
| 遷移請求 | "遷移到 XXX", "從 A 換到 B" |
| 升級請求 | "升級 XXX 到 v2", "升級 framework" |
| 替換請求 | "用 XXX 替換 YYY" |
| 關鍵字 | `遷移`, `替換`, `升級`, `migrate`, `replace` |

## 詳細步驟

### Step M: Migration Agent 規劃遷移

**輸入**：遷移需求

**執行**：
1. 分析當前狀態（使用的工具/框架/版本）
2. 研究目標狀態（新工具/框架的特性）
3. 相容性分析（API 差異、破壞性變更）
4. 風險評估（可能的問題和影響）
5. 制定遷移策略
6. 建立回滾計劃

**輸出**：遷移規劃文檔

```markdown
## 遷移規劃：[from] → [to]

### 範圍分析
- 影響檔案：X 個
- 影響模組：Y 個
- 風險等級：[Low/Medium/High]

### 遷移策略
[Big Bang / Strangler Fig / Branch by Abstraction]

### 任務分解
1. [Task 1]
2. [Task 2]
...

### 回滾計劃
[如何回滾到遷移前狀態]

### 需要新 Skill？
[是/否 + 說明]
```

**決策點**：
```
是否需要新 skill？
    │
    ├─ 是 → 進入 Step S
    │
    └─ 否 → 跳過 S→W，直接進入 Step D
```

### Step S: Skills Agent 建立新工具 Skill（條件性）

**觸發條件**：Migration Agent 判斷需要新 skill

**執行**：完整的 S→W 流程

```
Skills Agent 建立 skill
    ↓
Workflow Agent 驗證（Step W 的一部分）
    ↓
通過後繼續
```

**輸出**：新建立的 skill（如果需要）

For S→W details → see `skill-creation.md`

### Step W: Workflow Agent 設計執行流程

**輸入**：
- Migration Agent 的遷移規劃
- Skills Agent 建立的新 skill（如果有）

**執行**：
1. 分析遷移任務的依賴關係
2. 分配 Phase Batches（可並行的任務群組）
3. 設計執行順序
4. 定義驗證點
5. 準備 TodoWrite 任務列表

**輸出**：執行計劃

```markdown
## 執行計劃

### Phase 依賴分析
Phase 1: [任務 A, 任務 B] - 無依賴，可並行
Phase 2: [任務 C] - 依賴 Phase 1
Phase 3: [任務 D, 任務 E] - 依賴 Phase 2，可並行

### 驗證點
- Phase 1 完成後：[驗證項目]
- Phase 2 完成後：[驗證項目]
- 全部完成後：[最終驗證]

### 預估
- 總任務數：X
- 可並行度：Y%
- 預估 D→R→T 循環數：Z
```

### Step D→R→T: 實作循環

**執行**：標準的 D→R→T 流程，但有遷移特定的注意事項

#### D: Developer 實作

**遷移特定注意事項**：
- 保持向後相容（除非明確要求破壞性變更）
- 使用新 skill 中的知識（如果有建立）
- 遵循 Migration Agent 的遷移策略
- 每個步驟都要可回滾

#### R: Reviewer 審查

**遷移特定審查項目**：
- [ ] 是否遵循遷移策略？
- [ ] 是否保持向後相容？
- [ ] 是否可以回滾？
- [ ] 是否正確使用新 API？
- [ ] 是否有遺漏的遷移項目？

#### T: Tester 測試

**遷移特定測試項目**：
- [ ] 現有功能是否正常？（回歸測試）
- [ ] 新功能是否正常？
- [ ] 邊界情況是否處理？
- [ ] 效能是否符合預期？
- [ ] 回滾是否可行？（可選）

### 完成條件

```
所有 Phase 完成
    ↓
最終驗證
    ├─ 通過 → 遷移完成 ✅
    └─ 失敗 → 決定回滾或修復
```

## 流程變體

### 變體 1: 無需新 Skill

```
M → W → D → R → T
    (跳過 S)
```

**適用**：目標工具已有相關知識，不需要建立新 skill

### 變體 2: 簡單遷移

```
M → D → R → T
    (跳過 S 和 W 的深度設計)
```

**適用**：小範圍、低風險的遷移（例如小版本升級）

### 變體 3: 複雜遷移（完整流程）

```
M → S → W → D → R → T
         │
         └─ 可能多個 S→W 循環
            （需要多個新 skills）
```

**適用**：大規模遷移、多個新工具、高風險

## 回滾策略

### 何時回滾

| 情況 | 動作 |
|------|------|
| D→R→T 多次失敗 | 考慮回滾 |
| 發現重大相容性問題 | 評估回滾 |
| 遷移後效能嚴重下降 | 考慮回滾 |
| 用戶請求 | 執行回滾 |

### 回滾步驟

```
1. 停止所有進行中的遷移工作
2. 參考 Migration Agent 的回滾計劃
3. 執行回滾操作
4. 驗證系統恢復正常
5. 記錄失敗原因和教訓
```

### 回滾限制

| 參數 | 值 |
|------|-----|
| 可回滾視窗 | 遷移完成後 24 小時 |
| 部分回滾 | 支援（按 Phase 回滾）|

## 遷移策略參考

### Big Bang

```
┌────────────┐     ┌────────────┐
│   舊系統   │ ──→ │   新系統   │
│            │     │  (一次切換) │
└────────────┘     └────────────┘
```

**適用**：小型專案、低風險、可以停機

### Strangler Fig

```
┌────────────────────────────────┐
│         新系統（漸進擴展）      │
│    ┌──────────────────────┐   │
│    │ 舊系統（漸進縮小）     │   │
│    └──────────────────────┘   │
└────────────────────────────────┘
```

**適用**：大型專案、需要零停機、可以長期並存

### Branch by Abstraction

```
┌─────────────────────────────────┐
│          抽象層                  │
├─────────────────────────────────┤
│   舊實作   │      │   新實作    │
│  (feature  │      │  (feature   │
│   flag off)│      │   flag on)  │
└─────────────────────────────────┘
```

**適用**：需要逐步驗證、可以 feature toggle

## 輸出格式

### 遷移開始

```markdown
## 開始遷移：[from] → [to]

### 階段
1. M - Migration Agent 規劃中...
2. S - 待定（視需要）
3. W - 待定
4. D→R→T - 待定

### 預估
- 複雜度：[Low/Medium/High]
- 需要新 Skill：[是/否]
```

### 遷移完成

```markdown
## ✅ 遷移完成：[from] → [to]

### 執行摘要
- 總任務數：X
- D→R→T 循環：Y
- 新建 Skills：Z

### 變更列表
- [檔案/模組 1]：[變更說明]
- [檔案/模組 2]：[變更說明]

### 驗證結果
- 回歸測試：✅ 通過
- 功能測試：✅ 通過
- 效能測試：✅ 通過

### 回滾視窗
遷移後 24 小時內可回滾。過期後需重新評估。

### 後續建議
- [任何後續工作或觀察事項]
```

### 遷移失敗

```markdown
## ❌ 遷移失敗：[from] → [to]

### 失敗階段
[M/S/W/D/R/T]

### 失敗原因
[具體原因]

### 已執行回滾
[是/否]

### 建議
[下一步建議]
```

## Checklist

執行 M→S→W→D→R→T 流程時確認：

### M 階段
- [ ] 完成範圍分析
- [ ] 完成相容性分析
- [ ] 制定遷移策略
- [ ] 準備回滾計劃
- [ ] 決定是否需要新 skill

### S 階段（如需要）
- [ ] 建立新 skill
- [ ] 通過 Workflow Agent 驗證

### W 階段
- [ ] 分析任務依賴
- [ ] 分配 Phase Batches
- [ ] 定義驗證點
- [ ] 準備 TodoWrite 列表

### D→R→T 階段
- [ ] 按 Phase 執行
- [ ] 每個 Phase 後驗證
- [ ] 遵循遷移策略
- [ ] 保持可回滾

### 完成階段
- [ ] 最終驗證通過
- [ ] 輸出完成報告
- [ ] 通知回滾視窗
