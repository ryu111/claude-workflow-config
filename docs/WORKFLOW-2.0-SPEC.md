# å·¥ä½œæµ 2.0 è¦æ ¼

> Hook é©…å‹•çš„ç‹€æ…‹æ©Ÿå·¥ä½œæµç³»çµ±

---

## ä¸€ã€è¨­è¨ˆåŸå‰‡

### 1.1 æ ¸å¿ƒè®ŠåŒ–

| é …ç›® | 1.0 | 2.0 |
|------|-----|-----|
| æµç¨‹æ§åˆ¶ | CLAUDE.md + Skills è»Ÿæ€§ç´„æŸ | Hook ç‹€æ…‹æ©Ÿå¼·åˆ¶ |
| ç´„æŸåŠ› | ~60-80% | ~100%ï¼ˆé˜»æ“‹å‹ï¼‰ |
| ç´…ç·šè¦å‰‡ | æ–‡å­—å¼·èª¿ | åˆªé™¤ï¼ˆç”± Hook å–ä»£ï¼‰ |
| ç‹€æ…‹é¡¯ç¤º | Agent æ‰‹å‹•è¼¸å‡º | Hook è‡ªå‹•è¼¸å‡º |
| Session Report | Agent æ‰‹å‹•è¼¸å‡º | Hook è‡ªå‹•ç”Ÿæˆ |
| é›™è»ŒåŒæ­¥ | tasks.md + TodoWrite æ‰‹å‹• | é›™å‘è‡ªå‹•åŒæ­¥ |
| é€²ç¨‹ç®¡ç† | ç„¡ | Hook è¿½è¹¤ + è‡ªå‹•æ¸…ç† |

### 1.2 æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å·¥ä½œæµ 2.0 æ¶æ§‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   Main Agent                                                â”‚
â”‚       â”‚                                                     â”‚
â”‚       â”œâ”€â”€ Hook ç‹€æ…‹æ©Ÿï¼ˆå¼·åˆ¶ï¼‰                               â”‚
â”‚       â”‚     â”œâ”€â”€ ç‹€æ…‹è¿½è¹¤                                    â”‚
â”‚       â”‚     â”œâ”€â”€ è½‰æ›é©—è­‰ï¼ˆé˜»æ“‹éæ³•æ“ä½œï¼‰                    â”‚
â”‚       â”‚     â”œâ”€â”€ è‡ªå‹•è¼¸å‡ºç‹€æ…‹é¡¯ç¤º                            â”‚
â”‚       â”‚     â”œâ”€â”€ é€²ç¨‹è¿½è¹¤èˆ‡æ¸…ç†                              â”‚
â”‚       â”‚     â””â”€â”€ è‡ªå‹•ç”Ÿæˆå ±å‘Š                                â”‚
â”‚       â”‚                                                     â”‚
â”‚       â””â”€â”€ Task(sub agent)                                   â”‚
â”‚             â””â”€â”€ Sub Agent è®€å– Skillsï¼ˆå°ˆæ¥­çŸ¥è­˜ï¼‰           â”‚
â”‚                                                             â”‚
â”‚   ä¸å†éœ€è¦ï¼š                                                â”‚
â”‚   âŒ CLAUDE.md çš„å·¥ä½œæµè¦å‰‡                                 â”‚
â”‚   âŒ core skill çš„ Dâ†’Râ†’T è¦å‰‡                               â”‚
â”‚   âŒ main skill çš„èª¿åº¦è¦å‰‡                                  â”‚
â”‚   âŒ ç´…ç·šæé†’                                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€çµ±ä¸€æµç¨‹æ¨¡å‹

### 2.1 æ ¸å¿ƒæ¦‚å¿µ

```
[å‰ç½®] â†’ [ç”¢å‡º] â†’ [é©—è­‰] â†’ [å®Œæˆ]
```

| éšæ®µ | èªªæ˜ | ç‹€æ…‹ |
|------|------|------|
| å‰ç½® | è¦åŠƒã€è¨­è¨ˆã€é·ç§»è¦åŠƒï¼ˆå¯é¸ï¼‰ | PLANNING, DESIGN, MIGRATION_PLANNING |
| ç”¢å‡º | ç¨‹å¼ç¢¼æˆ– Skill æ–‡æª” | DEVELOP, SKILL_CREATE |
| é©—è­‰ | å¯©æŸ¥ + æ¸¬è©¦ æˆ– Skill é©—è­‰ | REVIEW â†’ TEST æˆ– VALIDATE |
| å®Œæˆ | æ­¸æª”ã€æ¸…ç†ã€å ±å‘Š | COMPLETING â†’ DONE |

### 2.2 æµç¨‹é¡å‹

| é¡å‹ | å‰ç½® | ç”¢å‡º | é©—è­‰ |
|------|------|------|------|
| ç¨‹å¼ç¢¼ | ARCHITECT/DESIGNER/MIGRATION | DEVELOP | REVIEW â†’ TEST |
| Skill | (éœ€æ±‚åˆ†æ) | SKILL_CREATE | VALIDATE |

---

## ä¸‰ã€å®Œæ•´ç‹€æ…‹æ©Ÿ

### 3.1 ç‹€æ…‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                     â”‚
â”‚  IDLE â”€â”€â†’ PLANNING â”€â”€â†’ [DESIGN] â”€â”€â†’ [MIGRATION_PLANNING]           â”‚
â”‚                                            â”‚                        â”‚
â”‚                                            â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ğŸ”„ LOOP æ¨¡å¼ï¼ˆå¯é¸ï¼‰                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚              ç”¢å‡ºéšæ®µ                            â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     DEVELOP â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    SKILL_CREATE        â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚        â”‚               â”‚         â”‚              â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚           â”‚               â”‚         â”‚                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚           â–¼               â”‚         â–¼                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚              é©—è­‰éšæ®µ                            â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     REVIEW â”€â”€â”€â†’ TEST         VALIDATE           â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚        â”‚          â”‚             â”‚               â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     REJECT      FAIL          FAIL              â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚        â”‚          â”‚             â”‚               â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚        â””â”€â”€â†’ DEVELOP â†â”€â”€ DEBUG â†â”€â”˜               â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                         â”‚                       â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                    (å‡ç´š opus)                   â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                         â”‚                       â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                      BLOCKED                    â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                    (éœ€ç”¨æˆ¶ä»‹å…¥)                  â”‚ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                        â”‚                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                     PASS                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                        â”‚                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                        â–¼                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              (ä¸‹ä¸€å€‹ä»»å‹™ æˆ– å…¨éƒ¨å®Œæˆ)                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                        â”‚                             â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                           â”‚                                â”‚   â”‚
â”‚  â”‚                           â–¼                                â”‚   â”‚
â”‚  â”‚                   LOOP_COMPLETING                          â”‚   â”‚
â”‚  â”‚                   (æ­¸æª”ã€æ¸…ç†ã€å ±å‘Š)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                     â”‚
â”‚                              â–¼                                     â”‚
â”‚                        COMPLETING                                  â”‚
â”‚                   (æ­¸æª”ã€é€²ç¨‹æ¸…ç†ã€å ±å‘Š)                           â”‚
â”‚                              â”‚                                     â”‚
â”‚                              â–¼                                     â”‚
â”‚                            DONE                                    â”‚
â”‚                                                                    â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                          ä¾‹å¤–ç‹€æ…‹                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                    â”‚
â”‚  PAUSED â†â”€â”€â”€â”€â”€â”€ ç”¨æˆ¶æš«åœ                                          â”‚
â”‚  LOOP_PAUSED â†â”€ Loop ä¸­æ–·ï¼ˆSession æ–·ç·š / ç”¨æˆ¶ä¸­æ–·ï¼‰              â”‚
â”‚  BLOCKED â†â”€â”€â”€â”€â”€ 2æ¬¡ DEBUG å¤±æ•— / éœ€è¦ç”¨æˆ¶ä»‹å…¥                     â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç‹€æ…‹å®šç¾©

| ç‹€æ…‹ | èªªæ˜ | é¡å‹ |
|------|------|------|
| **IDLE** | å¾…å‘½ï¼Œç„¡é€²è¡Œä¸­å·¥ä½œæµ | åˆå§‹ |
| **PLANNING** | ARCHITECT è¦åŠƒä¸­ | å‰ç½® |
| **DESIGN** | DESIGNER è¨­è¨ˆä¸­ | å‰ç½® |
| **MIGRATION_PLANNING** | MIGRATION è¦åŠƒä¸­ | å‰ç½® |
| **DEVELOP** | ç¨‹å¼ç¢¼é–‹ç™¼ä¸­ | ç”¢å‡º |
| **SKILL_CREATE** | Skill å»ºç«‹ä¸­ | ç”¢å‡º |
| **REVIEW** | ç¨‹å¼ç¢¼å¯©æŸ¥ä¸­ | é©—è­‰ |
| **TEST** | ç¨‹å¼ç¢¼æ¸¬è©¦ä¸­ | é©—è­‰ |
| **VALIDATE** | Skill é©—è­‰ä¸­ | é©—è­‰ |
| **DEBUG** | é™¤éŒ¯ä¸­ | ä¿®å¾© |
| **LOOP_PAUSED** | Loop ä¸­æ–·ï¼ˆå¯æ¢å¾©ï¼‰ | Loop |
| **LOOP_COMPLETING** | Loop çµæŸä¸­ | Loop |
| **COMPLETING** | å®Œæˆæµç¨‹ä¸­ï¼ˆæ­¸æª”ã€æ¸…ç†ã€å ±å‘Šï¼‰ | çµæŸ |
| **PAUSED** | ä¸€èˆ¬æš«åœ | ä¾‹å¤– |
| **BLOCKED** | é˜»å¡ï¼Œéœ€ç”¨æˆ¶ä»‹å…¥ | ä¾‹å¤– |
| **DONE** | å®Œæˆ | çµæŸ |

### 3.3 ç‹€æ…‹è½‰æ›è¦å‰‡

| å¾ | åˆ° | è§¸ç™¼æ¢ä»¶ | Hook å‹•ä½œ |
|----|----|-----------| ----------|
| IDLE | PLANNING | ç”¨æˆ¶èªªã€Œè¦åŠƒ xxxã€ | å…è¨± |
| PLANNING | DESIGN | è¦åŠƒå®Œæˆ + UI ä»»å‹™ | å…è¨± |
| PLANNING | MIGRATION_PLANNING | è¦åŠƒå®Œæˆ + é·ç§»ä»»å‹™ | å…è¨± |
| PLANNING | DEVELOP | è¦åŠƒå®Œæˆ | å…è¨± |
| DESIGN | DEVELOP | è¨­è¨ˆå®Œæˆ | å…è¨± |
| MIGRATION_PLANNING | DEVELOP | é·ç§»è¦åŠƒå®Œæˆ | å…è¨± |
| DEVELOP | REVIEW | é–‹ç™¼å®Œæˆ | **å¼·åˆ¶**ï¼ˆä¸å…è¨±è·³éï¼‰ |
| REVIEW | TEST | APPROVE | å…è¨± |
| REVIEW | DEVELOP | REJECT | å…è¨±ï¼ˆretry++ï¼‰ |
| TEST | COMPLETING/ä¸‹ä¸€ä»»å‹™ | PASS | å…è¨± |
| TEST | DEBUG | FAIL | å…è¨± |
| DEBUG | DEVELOP | ä¿®å¾©æ–¹æ¡ˆç”¢å‡º | å…è¨± |
| DEBUG | BLOCKED | 2æ¬¡å¤±æ•— | **å¼·åˆ¶** |
| * | PAUSED | ç”¨æˆ¶æš«åœ | å…è¨± |
| * | LOOP_PAUSED | Loop ä¸­æ–· | å…è¨± |
| LOOP_PAUSED | ä¹‹å‰ç‹€æ…‹ | ç”¨æˆ¶æ¢å¾© | å…è¨± |
| COMPLETING | DONE | æ¸…ç†å®Œæˆ | å…è¨± |

### 3.4 é˜»æ“‹è¦å‰‡ï¼ˆPreToolUse Hookï¼‰

| ç•¶å‰ç‹€æ…‹ | å˜—è©¦æ“ä½œ | çµæœ |
|----------|----------|------|
| DEVELOP | Edit/Write | âœ… å…è¨± |
| DEVELOP | Task(tester) | âŒ é˜»æ“‹ï¼šã€Œå¿…é ˆå…ˆç¶“é REVIEWã€ |
| REVIEW | Edit/Write | âŒ é˜»æ“‹ï¼šã€ŒREVIEW éšæ®µä¸èƒ½ä¿®æ”¹ç¨‹å¼ç¢¼ã€ |
| TEST | Edit/Write | âŒ é˜»æ“‹ï¼šã€ŒTEST éšæ®µä¸èƒ½ä¿®æ”¹ç¨‹å¼ç¢¼ã€ |
| é DEVELOP | Task(developer) | âŒ é˜»æ“‹ï¼šã€Œç•¶å‰ç‹€æ…‹ä¸å…è¨±é–‹ç™¼ã€ |

---

## å››ã€ç‹€æ…‹æ•¸æ“šçµæ§‹

### 4.1 ä¸»ç‹€æ…‹æª”æ¡ˆ

```
~/.claude/workflow-state/current.json
```

```json
{
  "version": "2.0",
  "state": "DEVELOP",
  "previousState": "PLANNING",
  "task": {
    "current": "2.1",
    "total": 8,
    "completed": 3
  },
  "changeId": "add-user-auth",
  "projectPath": "/path/to/project",
  "timestamps": {
    "workflowStarted": "2024-01-19T10:00:00Z",
    "stateChanged": "2024-01-19T10:30:00Z",
    "lastActivity": "2024-01-19T10:35:00Z"
  },
  "loop": {
    "active": true,
    "id": "loop-add-user-auth",
    "iteration": 3,
    "maxIterations": 10
  },
  "retries": {
    "develop": 0,
    "debug": 0
  },
  "processes": [
    {
      "pid": 12345,
      "pgid": 12345,
      "command": "pytest",
      "startedAt": "2024-01-19T10:32:00Z",
      "state": "TEST"
    }
  ],
  "bypass": [],
  "mainAgentOps": {
    "directEdits": 2,
    "delegated": 15,
    "blocked": 1,
    "bypassed": 0
  }
}
```

### 4.2 Bypass è¨˜éŒ„çµæ§‹

```json
{
  "bypass": [
    {
      "task": "2.3",
      "skippedState": "REVIEW",
      "reason": "ç·Šæ€¥ä¿®å¾©ï¼Œå·²äººå·¥ç¢ºèª",
      "timestamp": "2024-01-19T14:32:00Z"
    }
  ]
}
```

---

## äº”ã€é€²ç¨‹è¿½è¹¤èˆ‡æ¸…ç†

### 5.1 é€²ç¨‹è¿½è¹¤æ©Ÿåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é€²ç¨‹è¿½è¹¤æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  PreToolUse (Bash)                                              â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€ æª¢æ¸¬å‘½ä»¤æ˜¯å¦å¯èƒ½ç”¢ç”Ÿé•·æœŸé€²ç¨‹                          â”‚
â”‚       â”‚   (pytest, npm, node, playwright, etc.)                â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€ æ¨™è¨˜éœ€è¦è¿½è¹¤                                          â”‚
â”‚                                                                 â”‚
â”‚  PostToolUse (Bash)                                             â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â”€ å¦‚æœæ¨™è¨˜éœ€è¦è¿½è¹¤                                      â”‚
â”‚       â”‚   â”œâ”€â”€ è¨˜éŒ„ PID å’Œ PGID                                  â”‚
â”‚       â”‚   â”œâ”€â”€ è¨˜éŒ„å•Ÿå‹•æ™‚çš„ç‹€æ…‹                                  â”‚
â”‚       â”‚   â””â”€â”€ å¯«å…¥ workflow-state                               â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â”€ æ›´æ–° processes é™£åˆ—                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 éœ€è¿½è¹¤çš„å‘½ä»¤æ¨¡å¼

```javascript
const TRACKED_PATTERNS = [
  /pytest/,
  /python\s+-m\s+(pytest|unittest)/,
  /npm\s+(run|start|test)/,
  /yarn\s+(run|start|test)/,
  /node\s+/,
  /nodemon/,
  /ts-node/,
  /playwright/,
  /puppeteer/,
  /cypress/,
  /jest/,
  /vitest/,
  /webpack.*serve/,
  /vite/,
  /next\s+dev/
];
```

### 5.3 æ¸…ç†æ™‚æ©Ÿ

| æ™‚æ©Ÿ | æ¸…ç†ç¯„åœ | Hook |
|------|----------|------|
| ç‹€æ…‹è½‰æ› | è©²ç‹€æ…‹å•Ÿå‹•çš„é€²ç¨‹ | PostToolUse (state change) |
| ä»»å‹™å®Œæˆ | è©²ä»»å‹™çš„æ‰€æœ‰é€²ç¨‹ | PostToolUse (task complete) |
| COMPLETING | æ‰€æœ‰è¿½è¹¤çš„é€²ç¨‹ | ç‹€æ…‹è½‰æ› Hook |
| SessionEnd | å…œåº•æ¸…ç†æ‰€æœ‰æ®˜ç•™ | SessionEnd Hook |
| Loop ä¸­æ–· | æ¨™è¨˜ä½†ä¸ç«‹å³æ¸…ç† | Stop Hook |

### 5.4 æ¸…ç†ç­–ç•¥

```bash
# 1. å…ˆå˜—è©¦å„ªé›…çµ‚æ­¢
kill -TERM -$PGID  # çµ‚æ­¢æ•´å€‹é€²ç¨‹çµ„

# 2. ç­‰å¾… 5 ç§’
sleep 5

# 3. å¦‚æœé‚„åœ¨ï¼Œå¼·åˆ¶çµ‚æ­¢
kill -KILL -$PGID

# 4. é©—è­‰æ¸…ç†æˆåŠŸ
ps -p $PID > /dev/null 2>&1 && echo "è­¦å‘Šï¼šé€²ç¨‹æœªèƒ½æ¸…ç†"
```

### 5.5 é€²ç¨‹æ²™ç®±ï¼ˆå¯é¸å¢å¼·ï¼‰

```bash
# æ¯å€‹ Task ä½¿ç”¨ç¨ç«‹çš„ Process Group
setsid bash -c "command" &
PGID=$!

# è¨˜éŒ„ PGID åˆ°ç‹€æ…‹
# Task çµæŸæ™‚ kill æ•´å€‹ Group
```

---

## å…­ã€Escape Hatch æ©Ÿåˆ¶

### 6.1 è§¸ç™¼æ–¹å¼

```
ç”¨æˆ¶ï¼š/workflow bypass "åŸå› "
```

### 6.2 è¡Œç‚º

1. è¨˜éŒ„ bypass åˆ°ç‹€æ…‹æª”æ¡ˆ
2. å…è¨±è·³éç•¶å‰å¼·åˆ¶æ­¥é©Ÿ
3. ç¹¼çºŒåŸ·è¡Œ
4. **åœ¨ Session Report ä¸­é¡¯ç¤º**

### 6.3 é™åˆ¶

| é™åˆ¶ | å€¼ |
|------|-----|
| æ¯å€‹å·¥ä½œæµæœ€å¤š bypass | 3 æ¬¡ |
| ä¸å¯ bypass | COMPLETINGï¼ˆå¿…é ˆæ¸…ç†ï¼‰ |

---

## ä¸ƒã€è‡ªå‹•è¼¸å‡º

### 7.1 ç‹€æ…‹é¡¯ç¤ºæ ¼å¼ï¼ˆHook è‡ªå‹•è¼¸å‡ºï¼‰

**å–®ä¸€ Agentï¼š**
```markdown
## ğŸ’» DEVELOPER: Task 2.1 - å»ºç«‹ UserService
```

**ä¸¦è¡Œ Agentï¼š**
```markdown
## âš¡ ä¸¦è¡Œå•Ÿå‹• 3 å€‹ ğŸ’» DEVELOPER
- Task 2.1: å»ºç«‹ UserService
- Task 2.2: å»ºç«‹ AuthService
- Task 2.3: å»ºç«‹ PaymentService
```

**ç‹€æ…‹è½‰æ›ï¼š**
```markdown
## âœ… DEVELOP â†’ REVIEW: Task 2.1 é–‹ç™¼å®Œæˆ
## âŒ REVIEW â†’ DEVELOP: ç™¼ç¾ 2 å€‹å•é¡Œï¼Œéœ€è¦ä¿®å¾©
## âœ… TEST PASS: Task 2.1 å®Œæˆ (15/15 tests)
```

### 7.2 Session Report æ ¼å¼ï¼ˆHook è‡ªå‹•ç”Ÿæˆï¼‰

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                       Session Report
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š å·¥ä½œæµçµ±è¨ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… ä»»å‹™å®Œæˆ: 8/8 (100%)
ğŸ”„ Dâ†’Râ†’T éµå®ˆ: 8/8 (100%)
âš¡ ä¸¦è¡Œæ•ˆç‡: 4/4 (100%)
ğŸ“ è®Šæ›´: 12 files, +350 -120 lines

ğŸ”§ Debug è¨˜éŒ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Task 2.3: 1 æ¬¡ DEBUG (sonnet)ï¼Œå·²ä¿®å¾©

âš ï¸ Bypass è¨˜éŒ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Task 3.1 è·³é REVIEW
   åŸå› ï¼šã€Œç·Šæ€¥ä¿®å¾©ï¼Œå·²äººå·¥ç¢ºèªã€
   æ™‚é–“ï¼š2024-01-19 14:32

ğŸ§¹ é€²ç¨‹æ¸…ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- pytest (PID 12345) - å·²æ¸…ç†
- node dev server (PID 12346) - å·²æ¸…ç†
- æ®˜ç•™é€²ç¨‹: 0

ğŸ“‹ å§”æ´¾çµ±è¨ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Main ç›´æ¥æ“ä½œ: 2 (æ–‡æª”/é…ç½®)
å§”æ´¾è‡³ Sub Agent: 15
å˜—è©¦é•è¦è¢«é˜»æ“‹: 1
  - src/utils.ts â†’ æ”¹ç”¨ Task(developer)
å§”æ´¾ç‡: 15/17 (88%)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## å…«ã€tasks.md â†” TodoWrite é›™å‘åŒæ­¥

### 8.1 åŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     é›™å‘åŒæ­¥æ©Ÿåˆ¶                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  tasks.md   â”‚ â†â”€â”€â”€â”€ é›™å‘åŒæ­¥ â”€â”€â”€â”€â†’ â”‚  TodoWrite  â”‚          â”‚
â”‚  â”‚ ï¼ˆæª”æ¡ˆï¼‰     â”‚                      â”‚ ï¼ˆClaude UIï¼‰â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â†‘                                    â†‘                   â”‚
â”‚        â”‚                                    â”‚                   â”‚
â”‚   ARCHITECT                            ä»»å‹™å®Œæˆ                 â”‚
â”‚   ç”¢å‡ºä»»å‹™                             è‡ªå‹•å‹¾é¸                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 åŒæ­¥æ™‚æ©Ÿ

| æ™‚æ©Ÿ | æ–¹å‘ | å‹•ä½œ |
|------|------|------|
| ARCHITECT å®Œæˆ | tasks.md â†’ TodoWrite | è§£æ tasks.mdï¼Œå‘¼å« TodoWrite å»ºç«‹æ‰€æœ‰ä»»å‹™ |
| ä»»å‹™é–‹å§‹ (Task å•Ÿå‹•) | é›™å‘ | æ¨™è¨˜ `in_progress`ï¼ŒåŒæ­¥æ›´æ–° tasks.md |
| ä»»å‹™å®Œæˆ (TEST PASS) | é›™å‘ | æ¨™è¨˜ `completed`ï¼Œå‹¾é¸ tasks.md çš„ `[x]` |
| ç”¨æˆ¶æ‰‹å‹•å‹¾é¸ tasks.md | tasks.md â†’ TodoWrite | åŒæ­¥æ¨™è¨˜ç‚º completed |

### 8.3 tasks.md è§£æè¦å‰‡

```markdown
## 1. Setup (sequential)
- [ ] 1.1 Initialize project | files: package.json, tsconfig.json
- [x] 1.2 Configure ESLint | files: .eslintrc.js

## 2. Features (parallel)
- [ ] 2.1 User Dashboard | files: src/pages/dashboard.tsx | output: http://localhost:3000/dashboard
- [ ] 2.2 Settings Page | files: src/pages/settings.tsx
```

è§£æçµæœï¼š

```javascript
[
  { id: "1.1", content: "Initialize project", status: "pending", group: "Setup", mode: "sequential" },
  { id: "1.2", content: "Configure ESLint", status: "completed", group: "Setup", mode: "sequential" },
  { id: "2.1", content: "User Dashboard", status: "pending", group: "Features", mode: "parallel" },
  { id: "2.2", content: "Settings Page", status: "pending", group: "Features", mode: "parallel" }
]
```

### 8.4 TodoWrite æ ¼å¼å°æ‡‰

| tasks.md | TodoWrite |
|----------|-----------|
| `- [ ] 2.1 User Dashboard` | `{ content: "Task 2.1: User Dashboard", status: "pending", activeForm: "è™•ç† Task 2.1" }` |
| ä»»å‹™é–‹å§‹ | `status: "in_progress"`, `activeForm: "é–‹ç™¼ User Dashboard"` |
| REVIEW éšæ®µ | `activeForm: "å¯©æŸ¥ User Dashboard"` |
| TEST éšæ®µ | `activeForm: "æ¸¬è©¦ User Dashboard"` |
| å®Œæˆ | `status: "completed"` |

### 8.5 Hook å¯¦ç¾

```javascript
// hooks/workflow/task-sync.js (PostToolUse: Task, Edit)

// ç•¶ ARCHITECT å®Œæˆï¼ŒåŒæ­¥åˆ° TodoWrite
function syncTasksToTodo(tasksContent) {
  const tasks = parseTasksMd(tasksContent);
  // å‘¼å« TodoWrite API å»ºç«‹ä»»å‹™
}

// ç•¶ä»»å‹™å®Œæˆï¼ŒåŒæ­¥å› tasks.md
function syncTodoToTasks(taskId, status) {
  // æ›´æ–° tasks.md çš„ checkbox
  // [ ] â†’ [x]
}
```

### 8.6 ç‹€æ…‹è¿½è¹¤

```json
// workflow-state/current.json
{
  "taskSync": {
    "lastSyncAt": "2024-01-19T10:35:00Z",
    "tasksFile": "openspec/add-user-auth/tasks.md",
    "totalTasks": 8,
    "completed": 3,
    "inProgress": 1
  }
}
```

---

## ä¹ã€é…ç½®é›†ä¸­ç®¡ç†

### 9.1 é…ç½®æª”æ¡ˆ

```
~/.claude/workflow-config.json
```

```json
{
  "version": "2.0",
  "limits": {
    "maxRetries": 3,
    "maxDebugAttempts": 2,
    "maxIterations": 10,
    "maxBypass": 3,
    "idleTimeoutMinutes": 30
  },
  "debug": {
    "firstAttemptModel": "sonnet",
    "secondAttemptModel": "opus"
  },
  "processes": {
    "cleanupOnStateChange": true,
    "cleanupOnTaskComplete": true,
    "cleanupOnSessionEnd": true,
    "gracefulTerminateTimeout": 5000,
    "trackedPatterns": [
      "pytest",
      "npm",
      "node",
      "playwright"
    ]
  },
  "reporting": {
    "autoGenerateOnComplete": true,
    "includeBypassRecords": true,
    "includeProcessCleanup": true,
    "includeDebugHistory": true,
    "includeDelegationStats": true
  },
  "mainAgentLimits": {
    "enabled": true,
    "whitelist": ["*.md", "*.json", "*.yaml", "*.yml", ".env*", "openspec/**"],
    "blacklist": ["*.ts", "*.tsx", "*.js", "*.jsx", "*.py", "*.go", "*.rs", "*.java", "*.sh", "*.sql"],
    "testMode": false,
    "logBlockedAttempts": true
  }
}
```

---

## ä¹ã€Hook å¯¦ç¾æ¸…å–®

### 9.1 æ–°å¢ Hooksï¼ˆ2.0ï¼‰

| Hook | äº‹ä»¶ | åŠŸèƒ½ |
|------|------|------|
| `workflow-gate.js` | PreToolUse | ç‹€æ…‹æ©Ÿé˜»æ“‹é‚è¼¯ |
| `state-updater.js` | PostToolUse | ç‹€æ…‹è½‰æ›æ›´æ–° |
| `status-display.js` | PostToolUse | è‡ªå‹•è¼¸å‡ºç‹€æ…‹é¡¯ç¤º |
| `process-tracker.js` | PreToolUse (Bash) | æ¨™è¨˜éœ€è¿½è¹¤çš„å‘½ä»¤ |
| `process-recorder.js` | PostToolUse (Bash) | è¨˜éŒ„é€²ç¨‹ PID/PGID |
| `process-cleanup.js` | ç‹€æ…‹è½‰æ› / SessionEnd | æ¸…ç†é€²ç¨‹ |
| `session-report.js` | SessionEnd / COMPLETING | è‡ªå‹•ç”Ÿæˆå ±å‘Š |
| `bypass-handler.js` | Skill è§¸ç™¼ | è™•ç† bypass è«‹æ±‚ |
| `auto-preview.sh` | PostToolUse (Task) | ä»»å‹™å®Œæˆè‡ªå‹•é–‹å•Ÿæˆæœ |
| `task-sync.js` | PostToolUse (Task, Edit) | tasks.md â†” TodoWrite é›™å‘åŒæ­¥ |

### 9.2 ä¿ç•™ Hooksï¼ˆå¾ 1.0ï¼‰

| Hook | äº‹ä»¶ | åŠŸèƒ½ |
|------|------|------|
| `loop-heartbeat.sh` | PostToolUse | Loop å¿ƒè·³ |
| `loop-recovery-detector.js` | SessionStart | Loop æ¢å¾©æª¢æ¸¬ |
| `check-archive.sh` | SessionEnd | æ­¸æª”æª¢æŸ¥ |

### 9.3 åˆªé™¤ Hooksï¼ˆç”± 2.0 å–ä»£ï¼‰

| Hook | åŸå›  |
|------|------|
| `remind-review.sh` | ç”± `workflow-gate.js` é˜»æ“‹å–ä»£ |
| `workflow-violation-tracker.js` | ç”±ç‹€æ…‹æ©Ÿå–ä»£ |
| `delegation-logger.sh` | ç”± `state-updater.js` å–ä»£ |

---

## åã€æˆæœè‡ªå‹•å±•ç¤º

### 10.1 è§¸ç™¼æ™‚æ©Ÿ

| æ™‚æ©Ÿ | èªªæ˜ |
|------|------|
| ä»»å‹™å®Œæˆï¼ˆTEST PASSï¼‰ | è©²ä»»å‹™æœ‰å¯å±•ç¤ºæˆæœ |
| å·¥ä½œæµå®Œæˆï¼ˆCOMPLETINGï¼‰ | æœ€çµ‚æˆæœå±•ç¤º |

### 10.2 å¯å±•ç¤ºçš„æˆæœé¡å‹

| é¡å‹ | å‹•ä½œ | ç¯„ä¾‹ |
|------|------|------|
| **UI é é¢** | é–‹å•Ÿç€è¦½å™¨ | `http://localhost:3000/new-feature` |
| **HTML æª”æ¡ˆ** | é–‹å•Ÿç€è¦½å™¨ | `./dist/index.html` |
| **ç”Ÿæˆçš„æ–‡æª”** | é–‹å•Ÿç·¨è¼¯å™¨/é è¦½ | `./docs/api.md` |
| **æ¸¬è©¦å ±å‘Š** | é–‹å•Ÿç€è¦½å™¨ | `./coverage/index.html` |
| **è¨­è¨ˆç¨¿** | é–‹å•Ÿé è¦½ | `./ui-specs/component.html` |

### 10.3 tasks.md æ¨™è¨˜æ ¼å¼

```markdown
## 2. Features (parallel)
- [ ] 2.1 User Dashboard | files: src/pages/dashboard.tsx | output: http://localhost:3000/dashboard
- [ ] 2.2 Settings Page | files: src/pages/settings.tsx | output: http://localhost:3000/settings
- [ ] 2.3 Generate Docs | files: src/docs/ | output: ./docs/index.html
```

### 10.4 è‡ªå‹•å±•ç¤ºé‚è¼¯

```
ä»»å‹™å®Œæˆ (TEST PASS)
     â”‚
     â–¼
æª¢æŸ¥ tasks.md ä¸­çš„ output æ¬„ä½
     â”‚
     â”œâ”€ æœ‰ output
     â”‚      â”‚
     â”‚      â”œâ”€ http:// æˆ– https:// â†’ é–‹å•Ÿç€è¦½å™¨
     â”‚      â”œâ”€ .html æª”æ¡ˆ â†’ é–‹å•Ÿç€è¦½å™¨
     â”‚      â”œâ”€ .md æª”æ¡ˆ â†’ é–‹å•Ÿé è¦½
     â”‚      â””â”€ å…¶ä»– â†’ é–‹å•Ÿæª”æ¡ˆç®¡ç†å™¨
     â”‚
     â””â”€ ç„¡ output â†’ ä¸é–‹å•Ÿ
```

### 10.5 Hook å¯¦ç¾

```bash
#!/bin/bash
# hooks/workflow/auto-preview.sh (PostToolUse: Task)

# ç•¶ TESTER è¿”å› PASS æ™‚
# ä½¿ç”¨ open (macOS) / xdg-open (Linux) / start (Windows)

OUTPUT="$1"  # å¾ç‹€æ…‹æª”æ¡ˆè®€å–ï¼Œå·²é©—è­‰æ ¼å¼

case "$(uname)" in
  Darwin) open "$OUTPUT" ;;
  Linux)  xdg-open "$OUTPUT" ;;
  *)      start "$OUTPUT" ;;
esac
```

### 10.6 è¼¸å‡ºè¨Šæ¯

```markdown
## âœ… TEST PASS: Task 2.1 å®Œæˆ (15/15 tests)
## ğŸ–¥ï¸ é–‹å•Ÿé è¦½: http://localhost:3000/dashboard
```

### 10.7 é…ç½®é¸é …

```json
// workflow-config.json
{
  "preview": {
    "autoOpenOnTaskComplete": true,
    "autoOpenOnWorkflowComplete": true,
    "supportedTypes": ["http", "https", "html", "md", "pdf"],
    "delayMs": 1000
  }
}
```

---

## åä¸€ã€Emoji èˆ‡ç‹€æ…‹å°ç…§

| Emoji | Agent/ç‹€æ…‹ | ç”¨é€” |
|-------|------------|------|
| ğŸ—ï¸ | ARCHITECT | PLANNING |
| ğŸ¨ | DESIGNER | DESIGN |
| ğŸ”€ | MIGRATION | MIGRATION_PLANNING |
| ğŸ’» | DEVELOPER | DEVELOP |
| ğŸ“š | SKILLS | SKILL_CREATE |
| ğŸ” | REVIEWER | REVIEW |
| ğŸ§ª | TESTER | TEST |
| âœ… | WORKFLOW | VALIDATE |
| ğŸ› | DEBUGGER | DEBUG |
| â¸ï¸ | - | PAUSED / LOOP_PAUSED |
| ğŸš« | - | BLOCKED |
| ğŸ | - | COMPLETING |
| âœ… | - | DONE |
| âš¡ | - | ä¸¦è¡Œæ“ä½œ |

---

## åä¸€ã€èˆ‡ 1.0 å°ç…§

| åŠŸèƒ½ | 1.0 | 2.0 |
|------|-----|-----|
| Dâ†’Râ†’T å¼·åˆ¶ | æé†’ï¼ˆå¯å¿½ç•¥ï¼‰ | é˜»æ“‹ï¼ˆç„¡æ³•è·³éï¼‰ |
| ç‹€æ…‹é¡¯ç¤º | Agent æ‰‹å‹• | Hook è‡ªå‹• |
| Session Report | Agent æ‰‹å‹• | Hook è‡ªå‹• |
| é€²ç¨‹æ¸…ç† | ç„¡ | è‡ªå‹•è¿½è¹¤+æ¸…ç† |
| Escape Hatch | ç„¡ | æœ‰ï¼ˆè¨˜éŒ„+å ±å‘Šï¼‰ |
| é…ç½®ç®¡ç† | åˆ†æ•£å¤šæª”æ¡ˆ | é›†ä¸­ä¸€å€‹ JSON |
| æµç¨‹è®Šé«” | 5 ç¨® | 2 ç¨®ï¼ˆç¨‹å¼ç¢¼/Skillï¼‰ |
| ç´…ç·šè¦å‰‡ | 3 æ¢æ–‡å­— | åˆªé™¤ï¼ˆç”± Hook å¼·åˆ¶ï¼‰ |
| Debug å‡ç´š | 3 ç´š | 2 ç´šï¼ˆsonnet â†’ opus â†’ BLOCKEDï¼‰ |

---

## åäºŒã€Main Agent æ“ä½œé™åˆ¶

### 12.1 è¨­è¨ˆåŸå‰‡

Main Agent çš„è·è²¬æ˜¯**èª¿åº¦**ï¼Œä¸æ˜¯**åŸ·è¡Œ**ã€‚ä½†æŸäº›æ“ä½œä¸éœ€è¦å§”æ´¾ï¼Œæ‡‰å…è¨± Main ç›´æ¥è™•ç†ã€‚

### 12.2 ç™½åå–®/é»‘åå–®å®šç¾©

| é¡å‹ | æª”æ¡ˆæ¨¡å¼ | èªªæ˜ |
|------|----------|------|
| **ç™½åå–®ï¼ˆMain å¯ç·¨è¼¯ï¼‰** | `*.md` | æ–‡æª”æª”æ¡ˆ |
| | `*.json` | é…ç½®æª”æ¡ˆ |
| | `*.yaml`, `*.yml` | é…ç½®æª”æ¡ˆ |
| | `.env*` | ç’°å¢ƒè®Šæ•¸ï¼ˆéæ©Ÿå¯†ï¼‰ |
| | `tasks.md` | ä»»å‹™è¿½è¹¤ |
| | `openspec/**` | è¦æ ¼æ–‡ä»¶ |
| **é»‘åå–®ï¼ˆMain ç¦æ­¢ç·¨è¼¯ï¼‰** | `*.ts`, `*.tsx` | TypeScript ç¨‹å¼ç¢¼ |
| | `*.js`, `*.jsx` | JavaScript ç¨‹å¼ç¢¼ |
| | `*.py` | Python ç¨‹å¼ç¢¼ |
| | `*.go`, `*.rs` | Go/Rust ç¨‹å¼ç¢¼ |
| | `*.java`, `*.kt` | Java/Kotlin ç¨‹å¼ç¢¼ |
| | `*.swift`, `*.m` | Swift/ObjC ç¨‹å¼ç¢¼ |
| | `*.c`, `*.cpp`, `*.h` | C/C++ ç¨‹å¼ç¢¼ |
| | `*.rb`, `*.php` | Ruby/PHP ç¨‹å¼ç¢¼ |
| | `*.sh`, `*.bash` | Shell è…³æœ¬ |
| | `*.sql` | SQL è…³æœ¬ |
| | `*.vue`, `*.svelte` | å‰ç«¯æ¡†æ¶å…ƒä»¶ |

### 12.3 é˜»æ“‹é‚è¼¯

```javascript
// workflow-gate.js ä¸­çš„ Main Agent é™åˆ¶
function checkMainAgentLimit(toolName, params, state) {
  // åªåœ¨ Main Agent å˜—è©¦ Edit/Write æ™‚æª¢æŸ¥
  if (toolName !== 'Edit' && toolName !== 'Write') {
    return { allowed: true };
  }

  // å¦‚æœæ˜¯ Sub Agent åŸ·è¡Œï¼ˆåœ¨ Task å…§ï¼‰ï¼Œä¸é™åˆ¶
  if (state.inSubAgent) {
    return { allowed: true };
  }

  const filePath = params.file_path;
  const ext = path.extname(filePath).toLowerCase();

  // é»‘åå–®æª¢æŸ¥ï¼ˆç¨‹å¼ç¢¼æª”æ¡ˆï¼‰
  const CODE_EXTENSIONS = [
    '.ts', '.tsx', '.js', '.jsx', '.py', '.go', '.rs',
    '.java', '.kt', '.swift', '.m', '.c', '.cpp', '.h',
    '.rb', '.php', '.sh', '.bash', '.sql', '.vue', '.svelte'
  ];

  if (CODE_EXTENSIONS.includes(ext)) {
    return {
      allowed: false,
      reason: `Main Agent ä¸èƒ½ç›´æ¥ç·¨è¼¯ç¨‹å¼ç¢¼æª”æ¡ˆ (${ext})ã€‚è«‹ä½¿ç”¨ Task(developer) å§”æ´¾ã€‚`
    };
  }

  return { allowed: true };
}
```

### 12.4 ä¾‹å¤–æƒ…æ³

ä»¥ä¸‹æƒ…æ³å…è¨± Main ç›´æ¥æ“ä½œç¨‹å¼ç¢¼æª”æ¡ˆï¼š

| ä¾‹å¤– | èªªæ˜ | è™•ç†æ–¹å¼ |
|------|------|----------|
| **ç·Šæ€¥ä¿®å¾©** | ä¸€è¡Œ typo ä¿®å¾© | `/workflow bypass "typo fix"` |
| **ç”¨æˆ¶æ˜ç¢ºè¦æ±‚** | ç”¨æˆ¶èªªã€Œç›´æ¥æ”¹ã€ | è¦–ç‚ºè‡¨æ™‚ç™½åå–® |
| **æ¸¬è©¦ä¸­** | å·¥ä½œæµæœ¬èº«åœ¨æ¸¬è©¦ | é…ç½® `testMode: true` |

### 12.5 ç‹€æ…‹æ•¸æ“šçµæ§‹æ›´æ–°

```json
// workflow-state/current.json
{
  "mainAgentOps": {
    "directEdits": 2,     // Main ç›´æ¥ç·¨è¼¯æ¬¡æ•¸ï¼ˆç™½åå–®å…§ï¼‰
    "delegated": 15,      // å§”æ´¾æ¬¡æ•¸
    "blocked": 1,         // è¢«é˜»æ“‹æ¬¡æ•¸
    "bypassed": 0         // bypass æ¬¡æ•¸
  }
}
```

### 12.6 Session Report å§”æ´¾çµ±è¨ˆ

```
ğŸ“‹ å§”æ´¾çµ±è¨ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Main ç›´æ¥æ“ä½œ: 2 (æ–‡æª”/é…ç½®)
å§”æ´¾è‡³ Sub Agent: 15
å˜—è©¦é•è¦è¢«é˜»æ“‹: 1
  - src/utils.ts â†’ æ”¹ç”¨ Task(developer)
å§”æ´¾ç‡: 15/17 (88%)
```

### 12.7 é…ç½®é¸é …

```json
// workflow-config.json
{
  "mainAgentLimits": {
    "enabled": true,
    "whitelist": ["*.md", "*.json", "*.yaml", "*.yml", ".env*", "openspec/**"],
    "blacklist": ["*.ts", "*.tsx", "*.js", "*.jsx", "*.py", "*.go", "*.rs", "*.java", "*.sh", "*.sql"],
    "testMode": false,
    "logBlockedAttempts": true
  }
}
```

---

## åä¸‰ã€å¯¦ç¾å„ªå…ˆç´š

| å„ªå…ˆç´š | é …ç›® | èªªæ˜ |
|--------|------|------|
| P0 | workflow-gate.js | æ ¸å¿ƒé˜»æ“‹é‚è¼¯ï¼ˆå« Main Agent é™åˆ¶ï¼‰ |
| P0 | state-updater.js | ç‹€æ…‹è½‰æ› |
| P0 | workflow-state çµæ§‹ | ç‹€æ…‹æ•¸æ“šï¼ˆå« mainAgentOpsï¼‰ |
| P0 | task-sync.js | tasks.md â†” TodoWrite é›™å‘åŒæ­¥ |
| P1 | status-display.js | è‡ªå‹•é¡¯ç¤º |
| P1 | session-report.js | è‡ªå‹•å ±å‘Šï¼ˆå«å§”æ´¾çµ±è¨ˆï¼‰ |
| P1 | process-tracker/cleanup | é€²ç¨‹ç®¡ç† |
| P2 | bypass-handler.js | Escape Hatch |
| P2 | auto-preview.sh | æˆæœè‡ªå‹•å±•ç¤º |
| P2 | é…ç½®é›†ä¸­åŒ– | workflow-config.json |
