╔════════════════════════════════════════════════════════════════════════════╗
║                   state-updater.js 測試快速參考                           ║
╚════════════════════════════════════════════════════════════════════════════╝

【快速執行】
─────────────────────────────────────────────────────────────────────────────
cd /Users/sbu/.claude

# 執行所有測試
node tests/test-state-updater.js && node tests/test-state-updater-integration.js

【測試覆蓋範圍】
─────────────────────────────────────────────────────────────────────────────

generateAdHocChangeId()        ✅ 100% 覆蓋
  • 有 prompt 時：ad-hoc-${slug}-${timestamp}
  • 無 prompt 時：ad-hoc-${timestamp}
  • 唯一性：毫秒級時間戳
  • 字符過濾：[a-zA-Z0-9\u4e00-\u9fff\s]

resetWorkflowState()           ✅ 100% 覆蓋
  • 狀態物件初始化
  • 時間戳：ISO 8601 格式
  • mainAgentOps：計數重置為 0

Ad-hoc 初始化邏輯             ✅ 100% 覆蓋
  • DONE 狀態 → 初始化
  • IDLE 狀態 → 初始化
  • 其他狀態 → 不初始化

ARCHITECT 重置邏輯             ✅ 100% 覆蓋
  • changeId 生成
  • 狀態完全重置
  • delegated = 1

【測試統計】
─────────────────────────────────────────────────────────────────────────────
單元測試          19 個   (test-state-updater.js)
整合測試          11 個   (test-state-updater-integration.js)
總計              30 個   ✅ 全部通過

【被測源碼位置】
─────────────────────────────────────────────────────────────────────────────
/Users/sbu/.claude/plugins/workflow/hooks/state-updater.js

  第 224-237 行：generateAdHocChangeId()
  第 146-163 行：resetWorkflowState()
  第 367-418 行：Task 工具主邏輯
  第 374-387 行：ARCHITECT 委派邏輯
  第 391-395 行：Ad-hoc 初始化條件

【文檔位置】
─────────────────────────────────────────────────────────────────────────────
/Users/sbu/.claude/tests/workflow/

  README.md                      - 快速開始
  state-updater-test-report.md   - 詳細報告
  state-updater-testing-guide.md - 完整指南
  TESTING-SUMMARY.md             - 測試摘要
  QUICK-REFERENCE.txt            - 本檔案

/Users/sbu/.claude/TESTER-SUMMARY.md - 最終報告

【核心測試案例】
─────────────────────────────────────────────────────────────────────────────

1. changeId 唯一性
   - 連續 5 次呼叫應產生 5 個不同 ID
   - 通過毫秒級時間戳確保

2. 狀態重置完整性
   - 驗證所有必要欄位都被初始化
   - 檢查時間戳格式正確

3. 初始化觸發條件
   - DONE/IDLE → 初始化
   - 其他狀態 → 保持現狀

4. Agent 狀態映射
   - ARCHITECT → PLANNING
   - DEVELOPER → DEVELOP
   - REVIEWER → REVIEW
   - TESTER → TEST

【故障排除】
─────────────────────────────────────────────────────────────────────────────

測試失敗？檢查以下項目：
  1. Node.js 版本是否 v14+
  2. 檔案路徑是否正確
  3. 是否有讀取權限
  4. 是否有相依性缺失（本測試不需要）

測試掛起？
  1. Ctrl+C 強制中斷
  2. 檢查是否有死循環
  3. 檢查系統資源

【執行結果說明】
─────────────────────────────────────────────────────────────────────────────

✅ 測試通過
  表示該功能按預期工作，沒有問題

❌ 測試失敗
  檢查錯誤訊息，對比期望值和實際值
  可能原因：源碼邏輯改變、環境問題、依賴問題

【性能指標】
─────────────────────────────────────────────────────────────────────────────

執行時間    毫秒級（通常 < 100ms）
記憶體使用  最小化（< 50MB）
CPU 使用    < 1%
磁碟 I/O    無

【最後檢查清單】
─────────────────────────────────────────────────────────────────────────────

□ 所有 30 個測試都通過
□ 無錯誤訊息或警告
□ 代碼覆蓋率 100%
□ 文檔齊全
□ 可重複執行

【聯絡資訊】
─────────────────────────────────────────────────────────────────────────────

測試報告：TESTER-SUMMARY.md
源碼位置：plugins/workflow/hooks/state-updater.js
文檔根目錄：tests/workflow/

【最後更新】
─────────────────────────────────────────────────────────────────────────────
日期：2026-01-20
狀態：✅ 就緒交付
版本：1.0

